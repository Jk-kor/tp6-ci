name: CI Pipeline

# 1. 언제 실행할까? (트리거)
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# 2. 무슨 일을 할까? (Jobs)
jobs:
  # === 첫 번째 작업: 코드 품질 검사 ===
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: 코드 가져오기 (Checkout)
        uses: actions/checkout@v4

      - name: 파이썬 설치
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 의존성 설치
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 린트 검사 (Linting)
        run: |
          # 문법 오류나 스타일 체크
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: 테스트 실행 (Testing)
        run: |
          pytest

  # === 두 번째 작업: 도커 빌드 및 배포 ===
  docker-build:
    needs: quality  # 중요: 품질 검사가 성공해야만 실행됨!
    if: github.ref == 'refs/heads/main' # 중요: main 브랜치일 때만 실행!
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # GHCR에 업로드할 권한 필요

    steps:
      - name: 코드 가져오기
        uses: actions/checkout@v4

      - name: Docker Hub(GHCR) 로그인
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # [추가된 부분] 대문자 아이디를 소문자로 바꿔서 환경변수에 저장
      - name: 소문자로 변환 (Lowercase Repo Name)
        run: |
          echo "IMAGE_NAME=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: 도커 이미지 빌드 및 푸시
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # [변경된 부분] github.repository 대신 env.IMAGE_NAME 사용
          tags: ghcr.io/${{ env.IMAGE_NAME }}:latest